name: Auto_Sync OpenWRT Releases

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.get_release.outputs.release_tag }}
      can_build: ${{ steps.check_metadata.outputs.can_build }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # полный fetch для пуша

      - name: Get the latest OpenWrt release tag
        id: get_release
        run: |
          RELEASE_TAG=$(curl -s https://api.github.com/repos/immortalwrt/immortalwrt/tags | jq -r '.[0].name')
          # Убираем ведущую v, если есть
          RELEASE_TAG="${RELEASE_TAG#v}"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Check saved release tag and timestamp
        id: check_metadata
        run: |
          echo "Checking saved release metadata..."
          CAN_BUILD="false"
          CURRENT_TAG="${{ steps.get_release.outputs.release_tag }}"

          if [ -f saved_release_metadata.txt ]; then
            IFS=',' read SAVED_TAG SAVED_DATE < saved_release_metadata.txt
            echo "Saved Tag: $SAVED_TAG, Saved Date: $SAVED_DATE"
            echo "Latest Tag: $CURRENT_TAG"

            if [ "$SAVED_TAG" = "$CURRENT_TAG" ]; then
              SAVED_EPOCH=$(date -d "$SAVED_DATE" +%s)
              NOW_EPOCH=$(date +%s)

              AGE_HOURS=$(( (NOW_EPOCH - SAVED_EPOCH) / 3600 ))

              if (( AGE_HOURS <= 75 )); then
                echo "Tag same & age <= 100 hours -> CAN BUILD"
                CAN_BUILD="true"
              else
                echo "Tag same but older than 100 hours -> NO BUILD"
              fi
            else
              echo "New tag detected -> first detection, record it"
            fi

          else
            echo "No metadata file -> first detection"
          fi

          echo "can_build=$CAN_BUILD" >> $GITHUB_OUTPUT

      - name: Save release tag and current date (only on NEW tag)
        if: steps.check_metadata.outputs.can_build != 'true'
        run: |
          SAVED_TAG=""
          if [ -f saved_release_metadata.txt ]; then
            IFS=',' read SAVED_TAG SAVED_DATE < saved_release_metadata.txt
          fi

          CURRENT_TAG="${{ steps.get_release.outputs.release_tag }}"

          # Save only if NEW tag
          if [ "$SAVED_TAG" != "$CURRENT_TAG" ]; then
            echo "Saving new tag detection time"
            CURRENT_DATE=$(date "+%Y-%m-%d %H:%M:%S")
            echo "$CURRENT_TAG,$CURRENT_DATE" > saved_release_metadata.txt

            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"

            git add saved_release_metadata.txt
            git commit -m "Detected new release tag: $CURRENT_TAG" || echo "No changes"
            git pull --rebase origin main || true
            git push
          else
            echo "Tag unchanged — NOT updating detection time"
          fi

  build-awg:
    needs: sync-releases
    if: needs.sync-releases.outputs.can_build == 'true'
    uses: ./.github/workflows/Multi-Target Build AmneziaWG.yml
    with:
      openwrt_version: ${{ needs.sync-releases.outputs.release_tag }}
      amneziawg_version: main
      compile_kmod: true
      compile_go: true
