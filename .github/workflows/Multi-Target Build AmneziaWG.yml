name: Multi-Target Build AmneziaWG

on:
  workflow_call:
    inputs:
      openwrt_version:
        required: true
        type: string
      amneziawg_version:
        required: false
        type: string
        default: "main"
      compile_kmod:
        required: false
        type: boolean
        default: true
      compile_go:
        required: false
        type: boolean
        default: true

jobs:
  # 1. Генерируем полную матрицу целей
  generate-matrix:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install axios cheerio
      - name: Generate build matrix
        id: set-matrix
        run: |
          MATRIX=$(node index.js "${{ inputs.openwrt_version }}")
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # 2. Фильтруем матрицу — оставляем только те, которых ещё нет в релизе
  check-existing-assets:
    needs: generate-matrix
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.filter.outputs.matrix }}
    steps:
      - name: Get existing ZIPs from release
        id: get-assets
        run: |
          if [ "${{ inputs.openwrt_version }}" = "SNAPSHOT" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ inputs.openwrt_version }}" \
            | jq -r '.assets[].name | select(startswith("immortal-awg-2-"))' > existing.txt || true

      - name: Filter matrix – only targets that need to be built
        id: filter
        run: |
          ORIGINAL='${{ needs.generate-matrix.outputs.matrix }}'

          # Если SNAPSHOT — собираем всё
          if [ "${{ inputs.openwrt_version }}" = "SNAPSHOT" ]; then
            echo "matrix=$ORIGINAL" >> $GITHUB_OUTPUT
            echo "SNAPSHOT → build all targets"
            exit 0
          fi

          # Если релиз не найден или нет файлов — тоже собираем всё
          if [ ! -s existing.txt ]; then
            echo "matrix=$ORIGINAL" >> $GITHUB_OUTPUT
            echo "No existing ZIPs found → build all targets"
            exit 0
          fi

          # Надёжная фильтрация через jq
          FILTERED=$(jq -c --slurpfile existing existing.txt '
            .include |= map(select(
              "immortal-awg-2-${{ inputs.openwrt_version }}-\(.target)-\(.subtarget)-\(.pkgarch).zip" as $zip
              | $existing[] | IN($zip) | not
            ))
          ' <<< "$ORIGINAL")

          echo "matrix=$FILTERED" >> $GITHUB_OUTPUT
          echo "Targets left to build: $(jq '.include | length' <<< "$FILTERED")"

  # 3. Сборка только нужных целей
  build-awg:
    needs: [generate-matrix, check-existing-assets]
    if: ${{ inputs.openwrt_version == 'SNAPSHOT' || needs.check-existing-assets.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.check-existing-assets.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          path: amneziawg

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-pyelftools python3-dev python3-setuptools \
            swig curl zip zstd jq unzip build-essential libelf-dev

      - name: Checkout fresh golang from immortalwrt/packages
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/packages
          path: packages

      - name: Download and prepare SDK
        env:
          compile_go: ${{ inputs.compile_go }}
        run: |
          set -e
          VERSION="${{ inputs.openwrt_version }}"
          TARGET="${{ matrix.target }}"
          SUBTARGET="${{ matrix.subtarget }}"

          if [ "$VERSION" = "SNAPSHOT" ]; then
            BASE="https://downloads.immortalwrt.org/snapshots"
          else
            BASE="https://downloads.immortalwrt.org/releases/$VERSION"
          fi

          URL="$BASE/targets/$TARGET/$SUBTARGET"
          SDK=$(curl -s "$URL/" | grep -o 'immortalwrt-sdk.*\.\(tar\.xz\|tar\.zst\)' | head -1)
          curl -L "$URL/$SDK" -o sdk.archive

          if [[ $SDK == *.zst ]]; then
            unzstd sdk.archive
            tar -xf "${SDK%.zst}"
          else
            tar -xf sdk.archive
          fi
          rm -f sdk.archive
          mv immortalwrt-sdk* openwrt

          echo "src-link awg ../amneziawg" >> openwrt/feeds.conf.default
          # или src-cpy — как у тебя в пакете
          ./openwrt/scripts/feeds update -a
          ./openwrt/scripts/feeds install -a

          cat > openwrt/.config <<EOF
          CONFIG_PACKAGE_kmod-amneziawg=y
          CONFIG_PACKAGE_amneziawg-tools=y
          CONFIG_PACKAGE_luci-proto-amneziawg=y
          CONFIG_PACKAGE_kmod-crypto-lib-chacha20poly1305=y
          EOF
          ${{ inputs.compile_go == 'true' }} && echo "CONFIG_PACKAGE_amneziawg-go=y" >> openwrt/.config

          if [ "$compile_go" = "true" ]; then
            rm -rf openwrt/feeds/packages/lang/golang
            cp -r packages/lang/golang openwrt/feeds/packages/lang/
            ./openwrt/scripts/feeds update -a
          fi

          make -C openwrt defconfig

      - name: Compile packages
        run: |
          cd openwrt
          make package/kmod-amneziawg/compile -j$(nproc) V=s
          make package/amneziawg-tools/compile -j$(nproc) V=s
          make package/luci-proto-amneziawg/compile -j$(nproc) V=s
          ${{ inputs.compile_go == 'true' }} && make package/amneziawg-go/compile -j$(nproc) V=s || true

      - name: Upload ZIP to release
        run: |
          mkdir release
          cp openwrt/bin/targets/${{ matrix.target }}/${{ matrix.subtarget }}/packages/kmod-amneziawg_* release/ 2>/dev/null || true
          cp openwrt/bin/packages/${{ matrix.pkgarch }}/*/*amneziawg* release/ 2>/dev/null || true

          ZIP="immortal-awg-2-${{ inputs.openwrt_version }}-${{ matrix.target }}-${{ matrix.subtarget }}-${{ matrix.pkgarch }}.zip"
          zip -j "$ZIP" release/*

          gh release upload "${{ inputs.openwrt_version }}" "$ZIP" --clobber
