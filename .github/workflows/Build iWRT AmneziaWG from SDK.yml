name: New - Build iWRT AmneziaWG from SDK

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: "OpenWrt version"
        type: string
        required: true
        default: "25.12-SNAPSHOT"
      amneziawg_version:
        description: "AmneziaWG version"
        type: string
        required: true
        default: "main"
      openwrt_arch:
        description: "OpenWrt arch"
        type: string
        required: true
        default: "aarch64_generic"
      openwrt_target:
        description: "OpenWrt target"
        type: string
        required: true
        default: "rockchip"
      openwrt_subtarget:
        description: "OpenWrt subtarget"
        type: string
        required: true
        default: "armv8"
      compile_kmod:
        description: "Compile kernel module inplementation"
        type: boolean
        required: true
        default: true
      compile_go:
        description: "Compile Go implementation"
        type: boolean
        required: true
        default: true

jobs:
  build-amneziawg:
    name: "Build AmneziaWG for OpenWrt: ${{ inputs.openwrt_version }} - ${{ inputs.openwrt_arch }} - ${{ inputs.openwrt_target }}/${{ inputs.openwrt_subtarget }}"
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        path: amneziawg
        ref: ${{ inputs.amneziawg_version }}
        fetch-depth: 0

    - name: Checkout OpenWRT Packages repository
      uses: actions/checkout@v5
      if: ${{ inputs.compile_go }}
      with:
        path: packages
        repository: immortalwrt/packages
        fetch-depth: 0

    - name: Install additional packages
      run: |
        set -e -x
        sudo apt-get update
        sudo apt-get install -y python3-pyelftools python3-dev python3-setuptools swig curl zip zstd

    - name: Download and prepare SDK
      env:
        compile_go: ${{ inputs.compile_go }}
      run: |
        set -e -x

        TARGET="${{ inputs.openwrt_target }}"
        SUBTARGET="${{ inputs.openwrt_subtarget }}"
        VERSION="${{ inputs.openwrt_version }}"

        # Базовый URL (только releases, только SJTUG mirror)
        base_url="https://mirrors.sjtug.sjtu.edu.cn/immortalwrt/releases/$VERSION/targets/$TARGET/$SUBTARGET"

        # Ищем SDK
        sdk_url=$(curl -fsSL "${base_url}/" \
          | grep -oP 'href="[^"]*immortalwrt-sdk[^"]+\.tar\.zst"' \
          | sed -e 's/href="//' -e 's/"$//' \
          | head -n1 || true)

        if [[ -z "$sdk_url" ]]; then
            echo "SDK not found for $VERSION/$TARGET/$SUBTARGET"
            exit 1
        fi

        # Качаем и распаковываем SDK
        curl -fL --retry 5 --retry-all-errors --continue-at - -O "${base_url}/${sdk_url}"

        file_name=$(basename "$sdk_url")
        tar -xf "$file_name"
        rm -f "$file_name"

        # Папка SDK может называться openwrt-sdk-* или immortalwrt-sdk-*
        mv *sdk-* openwrt

        # Подключаем feed для AmneziaWG
        echo "src-cpy awgopenwrt ../amneziawg" >> openwrt/feeds.conf.default

        # --- повторное обновление feed с паузами ---
        MAX_ATTEMPTS=20
        attempt=1
        until ./openwrt/scripts/feeds update -a; do
          if [ $attempt -ge $MAX_ATTEMPTS ]; then
            echo "Ошибка: feeds update не удалось после $MAX_ATTEMPTS попыток" >&2
            exit 1
          fi
          echo "feeds update провалился (попытка $attempt/$MAX_ATTEMPTS), ждём 10–40 сек и пробуем снова..."
          sleep $((10 + RANDOM % 31))
          attempt=$((attempt + 1))
        done

        echo "Feeds успешно обновлены"

        curl -fsL "$base_url/config.buildinfo" > openwrt/.config
        echo "CONFIG_PACKAGE_kmod-crypto-kpp=y"                   >> openwrt/.config
        echo "CONFIG_PACKAGE_kmod-crypto-lib-chacha20=y"          >> openwrt/.config
        echo "CONFIG_PACKAGE_kmod-crypto-lib-chacha20poly1305=y"  >> openwrt/.config
        echo "CONFIG_PACKAGE_kmod-crypto-chacha20poly1305=y"      >> openwrt/.config
        echo "CONFIG_PACKAGE_kmod-amneziawg=y"                    >> openwrt/.config
        echo "CONFIG_PACKAGE_amneziawg-go=y"                      >> openwrt/.config
        echo "CONFIG_PACKAGE_amneziawg-tools=y"                   >> openwrt/.config
        echo "CONFIG_PACKAGE_luci-proto-amneziawg=y"              >> openwrt/.config

        # При необходимости заменяем golang
        if [ "${{ env.compile_go }}" = "true" ]; then
            rm -rf openwrt/feeds/packages/lang/golang
            cp -r packages/lang/golang openwrt/feeds/packages/lang
        fi

        # Устанавливаем feeds и генерим дефолтный конфиг
        ./openwrt/scripts/feeds install -a
        make -C openwrt defconfig
  
    - name: Compile AmneziaWG packages
      env:
        compile_kmod: ${{ inputs.compile_kmod }}
        compile_go: ${{ inputs.compile_go }}
      run: |
        set -e -x
        cd openwrt
        make package/kmod-amneziawg/{clean,download,prepare,compile} -j$(nproc)

        make package/amneziawg-tools/{clean,download,prepare,compile} -j$(nproc)

        make package/luci-proto-amneziawg/{clean,download,prepare,compile} -j$(nproc)

        if [ "$compile_go" = "true" ]; then
          make package/amneziawg-go/{clean,download,prepare,compile} V=s -j$(nproc) \
            || echo "amneziawg-go failed — continuing anyway"
        fi

    - name: Prepare artifacts
      run: |
        set -e -x
        mkdir awgrelease
        find "openwrt/bin/targets/${{ inputs.openwrt_target }}/${{ inputs.openwrt_subtarget }}/packages" \
          -type f -name '*amneziawg*' -exec cp {} awgrelease/ \; 2>/dev/null || true

        find "openwrt/bin/packages" \
          -type f -name '*amneziawg*' -exec cp {} awgrelease/ \; 2>/dev/null || true

    - name: Create zip
      run: zip -r immortal-amneziawg-${{ inputs.openwrt_version }}_${{ inputs.openwrt_arch }}_${{ inputs.openwrt_target }}_${{ inputs.openwrt_subtarget }}.zip awgrelease/
  
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortal-amneziawg-${{ inputs.openwrt_version }}_${{ inputs.openwrt_arch }}_${{ inputs.openwrt_target }}_${{ inputs.openwrt_subtarget }}
        path: immortal-amneziawg-*.zip
